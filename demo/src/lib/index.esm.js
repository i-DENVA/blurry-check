const e={getFloat32Array:e=>Array.isArray(e)?e.slice(0):new Float32Array(e),createImageData(e,t){const n=(()=>{if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")})().getContext("2d");if(!n)throw new Error("Could not get 2D context");return n.createImageData(e,t)},luminance(e){const t=this.createImageData(e.width,e.height),n=t.data,a=e.data;for(let e=0;e<a.length;e+=4){const t=.2126*a[e]+.7152*a[e+1]+.0722*a[e+2];n[e]=n[e+1]=n[e+2]=t,n[e+3]=a[e+3]}return t},convolve(e,t,n){const a=Math.round(Math.sqrt(t.length)),i=Math.floor(a/2),s=e.data,o=e.width,r=e.height,l=o,c=r,d=this.createImageData(l,c),h=d.data,g=n?1:0;for(let e=0;e<c;e++)for(let n=0;n<l;n++){const c=4*(e*l+n);let d=0,u=0,f=0,m=0;for(let l=0;l<a;l++)for(let c=0;c<a;c++){const h=4*(Math.min(r-1,Math.max(0,e+l-i))*o+Math.min(o-1,Math.max(0,n+c-i))),g=t[l*a+c];d+=s[h]*g,u+=s[h+1]*g,f+=s[h+2]*g,m+=s[h+3]*g}h[c]=d,h[c+1]=u,h[c+2]=f,h[c+3]=m+g*(255-m)}return d},gaussianBlur(e,t){if((t=Math.abs(t))<=1)return e;const n=t/2,a=Math.ceil(t)+(1-Math.ceil(t)%2),i=this.getFloat32Array(a),s=(n+.5)/3,o=s*s,r=1/Math.sqrt(2*Math.PI*o),l=-1/(2*s*s),c=Math.floor(a/2);let d=0;for(let e=0;e<a;e++){const t=e-c,n=r*Math.exp(t*t*l);Float32Array,i[e]=n,d+=n}for(let e=0;e<i.length;e++)Float32Array,i[e]/=d;const h=this.convolve(e,i,!0);return this.convolve(h,i,!0)}};class t{constructor(e="https://docs.opencv.org/4.5.4/opencv.js"){this.loading=!1,this.loaded=!1,this.openCvUrl=e}static getInstance(e){return t.instance||(t.instance=new t(e)),t.instance}async loadOpenCV(){if("undefined"==typeof window)throw new Error("OpenCV.js can only be loaded in browser environments");if(this.loaded&&window.cv)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#opencv-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src=this.openCvUrl,t.async=!0,t.id="opencv-script";const n=new Promise((e,n)=>{t.onload=()=>{const t=setInterval(()=>{window.cv&&(clearInterval(t),this.loaded=!0,this.loading=!1,e())},100);setTimeout(()=>{clearInterval(t),this.loading=!1,n(new Error("OpenCV loading timeout"))},1e4)},t.onerror=()=>{this.loading=!1,n(new Error("Failed to load OpenCV"))}});document.body.appendChild(t),await n}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const n=setInterval(()=>{this.loading||(clearInterval(n),this.loaded&&window.cv?e():t(new Error("OpenCV failed to load")))},100);setTimeout(()=>{clearInterval(n),t(new Error("OpenCV loading timeout"))},15e3)})}isLoaded(){return this.loaded&&"undefined"!=typeof window&&!!window.cv}getCV(){if(!this.isLoaded())throw new Error("OpenCV is not loaded. Call loadOpenCV() first.");return window.cv}}class n{constructor(e={}){var n,a,i,s,o,r;this.config={edgeWidthThreshold:null!==(n=e.edgeWidthThreshold)&&void 0!==n?n:.5,laplacianThreshold:null!==(a=e.laplacianThreshold)&&void 0!==a?a:100,method:null!==(i=e.method)&&void 0!==i?i:"edge",openCvUrl:null!==(s=e.openCvUrl)&&void 0!==s?s:"https://docs.opencv.org/4.5.4/opencv.js",canvas:null!==(o=e.canvas)&&void 0!==o?o:this.createCanvas(),debug:null!==(r=e.debug)&&void 0!==r&&r},this.openCvLoader=t.getInstance(this.config.openCvUrl)}createCanvas(){if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")}log(e,...t){this.config.debug&&console.log(`[BlurDetector] ${e}`,...t)}detectEdges(t){const n=e.luminance(t),a=e.getFloat32Array([1,0,-1,2,0,-2,1,0,-1]);return e.convolve(n,a,!0)}reducedPixels(e){const{data:t,width:n}=e,a=4*n,i=[];for(let e=0;e<t.length;e+=a){const s=new Uint8ClampedArray(n);let o=0;for(let n=e;n<e+a;n+=4)s[o]=t[n],o+=1;i.push(s)}return i}detectBlur(e){const t=e[0].length,n=e.length;let a=0,i=0;for(let s=0;s<n;s++){let n=-1;for(let o=0;o<t;o++){const t=e[s][o];if(n>=0&&o>n){const r=e[s][o-1];if(t<r){if(r>=20){a++,i+=o-n-1}n=-1}}0===t&&(n=o)}}if(0===a)return{width:t,height:n,numEdges:0,avgEdgeWidth:0,avgEdgeWidthPerc:0};const s=i/a;return{width:t,height:n,numEdges:a,avgEdgeWidth:s,avgEdgeWidthPerc:s/t*100}}measureBlurByEdges(e){const t=this.detectEdges(e),n=this.reducedPixels(t);return this.detectBlur(n)}async detectBlurrinessWithOpenCV(e){this.openCvLoader.isLoaded()||await this.openCvLoader.loadOpenCV();const t=this.openCvLoader.getCV(),n=t.matFromImageData(e),a=new t.Mat;t.cvtColor(n,a,t.COLOR_RGBA2GRAY,0);const i=new t.Mat;t.Laplacian(a,i,t.CV_64F);const s=new t.Mat,o=new t.Mat;t.meanStdDev(i,s,o);const r=o.data64F[0]**2;return n.delete(),a.delete(),i.delete(),s.delete(),o.delete(),r}async getImageData(e){if(e instanceof ImageData)return e;const t=this.config.canvas,n=t.getContext("2d");if(!n)throw new Error("Could not get 2D context from canvas");if(e instanceof File)return new Promise((a,i)=>{const s=new FileReader;s.onload=e=>{var s;const o=new Image;o.onload=()=>{t.width=o.width,t.height=o.height,n.drawImage(o,0,0),a(n.getImageData(0,0,t.width,t.height))},o.onerror=i,o.src=null===(s=e.target)||void 0===s?void 0:s.result},s.onerror=i,s.readAsDataURL(e)});if(e instanceof HTMLImageElement)return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height);if(e instanceof HTMLCanvasElement){const t=e.getContext("2d");if(!t)throw new Error("Could not get 2D context from source canvas");return t.getImageData(0,0,e.width,e.height)}throw new Error("Unsupported input type")}async analyzeImage(e){this.log("Starting blur analysis with method:",this.config.method);const t=await this.getImageData(e);this.log("Image data obtained:",t.width,"x",t.height);const n={isBlurry:!1,confidence:0,metrics:{},method:this.config.method};try{if("edge"===this.config.method||"both"===this.config.method){const e=this.measureBlurByEdges(t);n.metrics.edgeAnalysis=e;const a=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,i=e.numEdges<t.width*t.height/1e4,s=a||i;this.log("Edge analysis result:",e,"isBlurry:",a,"lowEdgeCount:",i,"combined:",s),"edge"===this.config.method&&(n.isBlurry=s,n.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1))}if("laplacian"===this.config.method||"both"===this.config.method)try{const e=await this.detectBlurrinessWithOpenCV(t);n.metrics.laplacianVariance=e;const a=e<this.config.laplacianThreshold;this.log("Laplacian analysis result:",e,"isBlurry:",a),"laplacian"===this.config.method&&(n.isBlurry=a,n.confidence=Math.min(this.config.laplacianThreshold/e,1))}catch(e){if(this.log("OpenCV analysis failed, falling back to edge detection:",e),"laplacian"===this.config.method){const e=this.measureBlurByEdges(t);n.metrics.edgeAnalysis=e,n.isBlurry=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,n.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1),n.method="edge (fallback)"}}if("both"===this.config.method){const e=!!n.metrics.edgeAnalysis&&n.metrics.edgeAnalysis.avgEdgeWidthPerc>this.config.edgeWidthThreshold,a=!!n.metrics.edgeAnalysis&&n.metrics.edgeAnalysis.numEdges<t.width*t.height/1e4,i=e||a,s=!!n.metrics.laplacianVariance&&n.metrics.laplacianVariance<this.config.laplacianThreshold;n.isBlurry=i||s;const o=n.metrics.edgeAnalysis?Math.min(n.metrics.edgeAnalysis.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1):0,r=n.metrics.laplacianVariance?Math.min(this.config.laplacianThreshold/n.metrics.laplacianVariance,1):0;n.confidence=Math.max(o,r)}return this.log("Final analysis result:",n),n}catch(e){throw this.log("Analysis failed:",e),new Error(`Blur analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isBlurry(e){return(await this.analyzeImage(e)).isBlurry}}var a=Object.freeze({__proto__:null,BlurDetector:n});class i{constructor(e={}){this.pdfLib=null,this.loading=!1,this.config=e,this.blurDetector=new n(e)}log(e,...t){this.config.debug&&console.log(`[PDFAnalyzer] ${e}`,...t)}async loadPdfJS(){if("undefined"==typeof window)throw new Error("PDF.js can only be loaded in browser environments");if(this.pdfLib)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#pdfjs-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.async=!0,t.id="pdfjs-script";const n=new Promise((e,n)=>{t.onload=()=>{window.pdfjsLib?(window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",this.pdfLib=window.pdfjsLib,this.loading=!1,e()):(this.loading=!1,n(new Error("PDF.js not available after loading")))},t.onerror=()=>{this.loading=!1,n(new Error("Failed to load PDF.js"))}});document.body.appendChild(t),await n}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const n=setInterval(()=>{this.loading||(clearInterval(n),this.pdfLib?e():t(new Error("PDF.js failed to load")))},100);setTimeout(()=>{clearInterval(n),t(new Error("PDF.js loading timeout"))},15e3)})}async checkPdfPageQuality(e,t){const n=await e.getPage(t),i=[1,1.5,2],s=[];for(const e of i){const i=n.getViewport({scale:e}),o=this.config.canvas||document.createElement("canvas"),r=o.getContext("2d");if(!r)throw new Error("Could not get 2D context from canvas");o.width=i.width,o.height=i.height;const l={canvasContext:r,viewport:i};await n.render(l).promise;const c=r.getImageData(0,0,o.width,o.height),d=new((await Promise.resolve().then(function(){return a})).BlurDetector)({...this.config,edgeWidthThreshold:Math.min(this.config.edgeWidthThreshold||.5,.25),method:"edge",debug:this.config.debug}),h=await d.analyzeImage(c);h.method=`${h.method} (scale ${e}x)`,s.push(h),this.log(`Page ${t} at ${e}x scale:`,h)}const o=s.filter(e=>e.isBlurry).length,r=s.reduce((e,t)=>e+t.confidence,0)/s.length,l=s[s.length-1];return{...l,isBlurry:o>0,confidence:Math.max(r,o/s.length),method:`Multi-scale analysis (${o}/${s.length} scales detected blur)`,metrics:{...l.metrics,scaleResults:s.map(e=>{var t;return{scale:parseFloat((null===(t=e.method.match(/scale ([\d.]+)x/))||void 0===t?void 0:t[1])||"1"),isBlurry:e.isBlurry,confidence:e.confidence,edgeAnalysis:e.metrics.edgeAnalysis}})}}}analyzePageContent(e,t){const n=e.items||[],a=n.map(e=>e.str).join(" ").trim(),i=a.length,s=1===t,o=i<200,r=i/Math.max(n.length,1),l=/bill|statement|invoice|report|summary|account|period/i.test(a),c=/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\w+ \d{1,2}, \d{4}/i.test(a),d=/\$[\d,]+\.?\d*|USD|EUR|GBP/i.test(a),h=s&&(o||l&&c&&d&&i<500);return this.log(`Page ${t} content analysis: textLength=${i}, textDensity=${r.toFixed(1)}, isLikelyHeader=${h}`),{isLikelyHeaderPage:h,textDensity:r,hasLowTextContent:o}}async analyzeTextSharpness(e,t){const n=await e.getPage(t),a=await n.getTextContent();if(0===a.items.length)return{textSharpnessScore:0,isTextBlurry:!0,textMetrics:{reason:"No text found"}};const i=n.getViewport({scale:3}),s=document.createElement("canvas"),o=s.getContext("2d");if(!o)throw new Error("Could not get 2D context for text analysis");s.width=i.width,s.height=i.height;const r={canvasContext:o,viewport:i,intent:"print"};await n.render(r).promise;const l=o.getImageData(0,0,s.width,s.height),c=this.calculateTextSharpness(l,a.items);return this.log(`Page ${t} text sharpness analysis:`,c),c}calculateTextSharpness(e,t){const{data:n,width:a,height:i}=e;let s=0,o=0,r=0;const l=Math.max(1,Math.floor(Math.min(a,i)/100));for(let e=0;e<i-5;e+=l)for(let t=0;t<a-5;t+=l){let i=0,l=0,c=0,d=0;for(let s=0;s<5;s++)for(let o=0;o<5;o++){const r=4*((e+s)*a+(t+o)),h=.299*n[r]+.587*n[r+1]+.114*n[r+2];if(i+=h,l+=h*h,c++,o<4&&s<4){const i=4*((e+s)*a+(t+o+1)),r=4*((e+s+1)*a+(t+o)),l=.299*n[i]+.587*n[i+1]+.114*n[i+2]-h,c=.299*n[r]+.587*n[r+1]+.114*n[r+2]-h,g=Math.sqrt(l*l+c*c);d=Math.max(d,g)}}if(c>0){const e=i/c,t=l/c-e*e;t>100&&(s+=t,r+=d,o++)}}const c=o>0?s/o:0,d=o>0?r/o:0,h=c/1e3+d/50;return{textSharpnessScore:h,isTextBlurry:h<.8,textMetrics:{avgVariance:c,avgEdgeIntensity:d,sampleCount:o,threshold:.8}}}async analyzePDF(e){this.log("Starting PDF analysis for file:",e.name),this.pdfLib||await this.loadPdfJS();try{const t=await e.arrayBuffer(),n=await this.pdfLib.getDocument({data:new Uint8Array(t)}).promise;let a="",i=!1;const s=[];this.log(`PDF has ${n.numPages} pages`);for(let e=1;e<=n.numPages;e++){this.log(`Analyzing page ${e}/${n.numPages}`);const t=await n.getPage(e),o=await t.getTextContent();0===o.items.length&&(i=!0),a+=o.items.map(e=>e.str).join(" ");try{const t=this.analyzePageContent(o,e),a=await this.checkPdfPageQuality(n,e);if(o.items.length>0)try{const i=await this.analyzeTextSharpness(n,e);let o=a.isBlurry||i.isTextBlurry;t.isLikelyHeaderPage&&(o=i.textSharpnessScore<.5,this.log(`Page ${e} identified as likely header/logo page - using lenient blur criteria`));const r={...a,isBlurry:o,confidence:Math.max(a.confidence,i.textSharpnessScore),method:`${a.method} + Text Analysis${t.isLikelyHeaderPage?" (Header-adjusted)":""}`,metrics:{...a.metrics,textSharpness:i,contentAnalysis:t}};s.push(r),this.log(`Page ${e} combined analysis:`,r)}catch(t){this.log(`Text analysis failed for page ${e}:`,t),s.push(a)}else s.push(a)}catch(t){this.log(`Failed to analyze page ${e}:`,t)}}const o=a.length>=10,r=i||!o;this.log(`PDF analysis complete. Scanned: ${r}, Text length: ${a.length}`);let l=!0;if(s.length>0){const e=s.filter(e=>e.isBlurry);if(s.length>1){const e=s.slice(1),t=e.filter(e=>e.isBlurry),n=s[0].isBlurry,a=t.length>0;n&&!a?(this.log("First page marked as blurry but rest are clear - likely false positive due to graphics/logos"),l=!0):l=!(t.length>=Math.ceil(e.length/2)),this.log(`Smart quality check: First page blurry: ${n}, Rest pages blurry: ${t.length}/${e.length}, Final decision: ${l?"Good":"Poor"}`)}else l=0===e.length,this.log(`Single page quality check: ${e.length}/${s.length} pages are blurry`);this.log("PDF type: "+(r?"Scanned":"Text-based"))}const c={isQualityGood:l,isScanned:r,pagesAnalyzed:n.numPages,textLength:a.length,pageResults:s.length>0?s:void 0};return this.log("Final PDF analysis result:",c),c}catch(e){throw this.log("PDF analysis failed:",e),new Error(`PDF analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isGoodQuality(e){return(await this.analyzePDF(e)).isQualityGood}}class s{constructor(e={}){this.config={edgeWidthThreshold:.5,laplacianThreshold:100,method:"edge",debug:!1,...e},this.blurDetector=new n(this.config),this.pdfAnalyzer=new i(this.config)}async isImageBlurry(e){return this.blurDetector.isBlurry(e)}async analyzeImage(e){return this.blurDetector.analyzeImage(e)}async isPDFGoodQuality(e){return this.pdfAnalyzer.isGoodQuality(e)}async analyzePDF(e){return this.pdfAnalyzer.analyzePDF(e)}async analyzeFile(e,t={}){var a;const s=null===(a=e.name.split(".").pop())||void 0===a?void 0:a.toLowerCase(),o={...this.config,...t};if("pdf"===s){return new i(o).analyzePDF(e)}if(["png","jpg","jpeg","gif","bmp","webp"].includes(s||"")){return new n(o).analyzeImage(e)}throw new Error(`Unsupported file type: ${s}`)}async isFileGoodQuality(e,t={}){const n=await this.analyzeFile(e,t);return"isQualityGood"in n?n.isQualityGood:!n.isBlurry}updateConfig(e){this.config={...this.config,...e},this.blurDetector=new n(this.config),this.pdfAnalyzer=new i(this.config)}getConfig(){return{...this.config}}}async function o(e,t){return new s(t).isImageBlurry(e)}async function r(e,t){return new s(t).isPDFGoodQuality(e)}async function l(e,t){return new s(t).analyzeFile(e,t)}export{n as BlurDetector,s as BlurryCheck,e as Filters,t as OpenCVLoader,i as PDFAnalyzer,l as analyzeFile,s as default,o as isImageBlurry,r as isPDFGoodQuality};
//# sourceMappingURL=index.esm.js.map
