const e={getFloat32Array:e=>Array.isArray(e)?e.slice(0):new Float32Array(e),createImageData(e,t){const n=(()=>{if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")})().getContext("2d");if(!n)throw new Error("Could not get 2D context");return n.createImageData(e,t)},luminance(e){const t=this.createImageData(e.width,e.height),n=t.data,i=e.data;for(let e=0;e<i.length;e+=4){const t=.2126*i[e]+.7152*i[e+1]+.0722*i[e+2];n[e]=n[e+1]=n[e+2]=t,n[e+3]=i[e+3]}return t},convolve(e,t,n){const i=Math.round(Math.sqrt(t.length)),a=Math.floor(i/2),s=e.data,r=e.width,o=e.height,l=r,c=o,d=this.createImageData(l,c),h=d.data,g=n?1:0;for(let e=0;e<c;e++)for(let n=0;n<l;n++){const c=4*(e*l+n);let d=0,u=0,f=0,m=0;for(let l=0;l<i;l++)for(let c=0;c<i;c++){const h=4*(Math.min(o-1,Math.max(0,e+l-a))*r+Math.min(r-1,Math.max(0,n+c-a))),g=t[l*i+c];d+=s[h]*g,u+=s[h+1]*g,f+=s[h+2]*g,m+=s[h+3]*g}h[c]=d,h[c+1]=u,h[c+2]=f,h[c+3]=m+g*(255-m)}return d},gaussianBlur(e,t){if((t=Math.abs(t))<=1)return e;const n=t/2,i=Math.ceil(t)+(1-Math.ceil(t)%2),a=this.getFloat32Array(i),s=(n+.5)/3,r=s*s,o=1/Math.sqrt(2*Math.PI*r),l=-1/(2*s*s),c=Math.floor(i/2);let d=0;for(let e=0;e<i;e++){const t=e-c,n=o*Math.exp(t*t*l);Float32Array,a[e]=n,d+=n}for(let e=0;e<a.length;e++)Float32Array,a[e]/=d;const h=this.convolve(e,a,!0);return this.convolve(h,a,!0)}};class t{constructor(e="https://docs.opencv.org/4.5.4/opencv.js"){this.loading=!1,this.loaded=!1,this.openCvUrl=e}static getInstance(e){return t.instance||(t.instance=new t(e)),t.instance}async loadOpenCV(){if("undefined"==typeof window)throw new Error("OpenCV.js can only be loaded in browser environments");if(this.loaded&&window.cv)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#opencv-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src=this.openCvUrl,t.async=!0,t.id="opencv-script";const n=new Promise((e,n)=>{t.onload=()=>{const t=setInterval(()=>{window.cv&&(clearInterval(t),this.loaded=!0,this.loading=!1,e())},100);setTimeout(()=>{clearInterval(t),this.loading=!1,n(new Error("OpenCV loading timeout"))},1e4)},t.onerror=()=>{this.loading=!1,n(new Error("Failed to load OpenCV"))}});document.body.appendChild(t),await n}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const n=setInterval(()=>{this.loading||(clearInterval(n),this.loaded&&window.cv?e():t(new Error("OpenCV failed to load")))},100);setTimeout(()=>{clearInterval(n),t(new Error("OpenCV loading timeout"))},15e3)})}isLoaded(){return this.loaded&&"undefined"!=typeof window&&!!window.cv}getCV(){if(!this.isLoaded())throw new Error("OpenCV is not loaded. Call loadOpenCV() first.");return window.cv}}class n{constructor(e={}){var n,i,a,s,r,o;this.config={edgeWidthThreshold:null!==(n=e.edgeWidthThreshold)&&void 0!==n?n:.5,laplacianThreshold:null!==(i=e.laplacianThreshold)&&void 0!==i?i:100,method:null!==(a=e.method)&&void 0!==a?a:"edge",openCvUrl:null!==(s=e.openCvUrl)&&void 0!==s?s:"https://docs.opencv.org/4.5.4/opencv.js",canvas:null!==(r=e.canvas)&&void 0!==r?r:this.createCanvas(),debug:null!==(o=e.debug)&&void 0!==o&&o},this.openCvLoader=t.getInstance(this.config.openCvUrl)}createCanvas(){if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")}log(e,...t){this.config.debug&&console.log(`[BlurDetector] ${e}`,...t)}detectEdges(t){const n=e.luminance(t),i=e.getFloat32Array([1,0,-1,2,0,-2,1,0,-1]);return e.convolve(n,i,!0)}reducedPixels(e){const{data:t,width:n}=e,i=4*n,a=[];for(let e=0;e<t.length;e+=i){const s=new Uint8ClampedArray(n);let r=0;for(let n=e;n<e+i;n+=4)s[r]=t[n],r+=1;a.push(s)}return a}detectBlur(e){const t=e[0].length,n=e.length;let i=0,a=0;for(let s=0;s<n;s++){let n=-1;for(let r=0;r<t;r++){const t=e[s][r];if(n>=0&&r>n){const o=e[s][r-1];if(t<o){if(o>=20){i++,a+=r-n-1}n=-1}}0===t&&(n=r)}}if(0===i)return{width:t,height:n,numEdges:0,avgEdgeWidth:0,avgEdgeWidthPerc:0};const s=a/i;return{width:t,height:n,numEdges:i,avgEdgeWidth:s,avgEdgeWidthPerc:s/t*100}}measureBlurByEdges(e){const t=this.detectEdges(e),n=this.reducedPixels(t);return this.detectBlur(n)}async detectBlurrinessWithOpenCV(e){this.openCvLoader.isLoaded()||await this.openCvLoader.loadOpenCV();const t=this.openCvLoader.getCV(),n=t.matFromImageData(e),i=new t.Mat;t.cvtColor(n,i,t.COLOR_RGBA2GRAY,0);const a=new t.Mat;t.Laplacian(i,a,t.CV_64F);const s=new t.Mat,r=new t.Mat;t.meanStdDev(a,s,r);const o=r.data64F[0]**2;return n.delete(),i.delete(),a.delete(),s.delete(),r.delete(),o}async getImageData(e){if(e instanceof ImageData)return e;const t=this.config.canvas,n=t.getContext("2d");if(!n)throw new Error("Could not get 2D context from canvas");if(e instanceof File)return new Promise((i,a)=>{const s=new FileReader;s.onload=e=>{var s;const r=new Image;r.onload=()=>{t.width=r.width,t.height=r.height,n.drawImage(r,0,0),i(n.getImageData(0,0,t.width,t.height))},r.onerror=a,r.src=null===(s=e.target)||void 0===s?void 0:s.result},s.onerror=a,s.readAsDataURL(e)});if(e instanceof HTMLImageElement)return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height);if(e instanceof HTMLCanvasElement){const t=e.getContext("2d");if(!t)throw new Error("Could not get 2D context from source canvas");return t.getImageData(0,0,e.width,e.height)}throw new Error("Unsupported input type")}async analyzeImage(e){this.log("Starting blur analysis with method:",this.config.method);const t=await this.getImageData(e);this.log("Image data obtained:",t.width,"x",t.height);const n={isBlurry:!1,confidence:0,metrics:{},method:this.config.method};try{if("edge"===this.config.method||"both"===this.config.method){const e=this.measureBlurByEdges(t);n.metrics.edgeAnalysis=e;const i=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,a=e.numEdges<t.width*t.height/1e4,s=i||a;this.log("Edge analysis result:",e,"isBlurry:",i,"lowEdgeCount:",a,"combined:",s),"edge"===this.config.method&&(n.isBlurry=s,n.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1))}if("laplacian"===this.config.method||"both"===this.config.method)try{const e=await this.detectBlurrinessWithOpenCV(t);n.metrics.laplacianVariance=e;const i=e<this.config.laplacianThreshold;this.log("Laplacian analysis result:",e,"isBlurry:",i),"laplacian"===this.config.method&&(n.isBlurry=i,n.confidence=Math.min(this.config.laplacianThreshold/e,1))}catch(e){if(this.log("OpenCV analysis failed, falling back to edge detection:",e),"laplacian"===this.config.method){const e=this.measureBlurByEdges(t);n.metrics.edgeAnalysis=e,n.isBlurry=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,n.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1),n.method="edge (fallback)"}}if("both"===this.config.method){const e=!!n.metrics.edgeAnalysis&&n.metrics.edgeAnalysis.avgEdgeWidthPerc>this.config.edgeWidthThreshold,i=!!n.metrics.edgeAnalysis&&n.metrics.edgeAnalysis.numEdges<t.width*t.height/1e4,a=e||i,s=!!n.metrics.laplacianVariance&&n.metrics.laplacianVariance<this.config.laplacianThreshold;n.isBlurry=a||s;const r=n.metrics.edgeAnalysis?Math.min(n.metrics.edgeAnalysis.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1):0,o=n.metrics.laplacianVariance?Math.min(this.config.laplacianThreshold/n.metrics.laplacianVariance,1):0;n.confidence=Math.max(r,o)}return this.log("Final analysis result:",n),n}catch(e){throw this.log("Analysis failed:",e),new Error(`Blur analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isBlurry(e){return(await this.analyzeImage(e)).isBlurry}}var i=Object.freeze({__proto__:null,BlurDetector:n});class a{constructor(e={}){this.pdfLib=null,this.loading=!1,this.config=e,this.blurDetector=new n(e)}log(e,...t){this.config.debug&&console.log(`[PDFAnalyzer] ${e}`,...t)}async loadPdfJS(){if("undefined"==typeof window)throw new Error("PDF.js can only be loaded in browser environments");if(this.pdfLib)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#pdfjs-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.async=!0,t.id="pdfjs-script";const n=new Promise((e,n)=>{t.onload=()=>{window.pdfjsLib?(window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",this.pdfLib=window.pdfjsLib,this.loading=!1,e()):(this.loading=!1,n(new Error("PDF.js not available after loading")))},t.onerror=()=>{this.loading=!1,n(new Error("Failed to load PDF.js"))}});document.body.appendChild(t),await n}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const n=setInterval(()=>{this.loading||(clearInterval(n),this.pdfLib?e():t(new Error("PDF.js failed to load")))},100);setTimeout(()=>{clearInterval(n),t(new Error("PDF.js loading timeout"))},15e3)})}async checkPdfPageQuality(e,t){const n=await e.getPage(t),a=[1,1.5,2],s=[];for(const e of a){const a=n.getViewport({scale:e}),r=this.config.canvas||document.createElement("canvas"),o=r.getContext("2d");if(!o)throw new Error("Could not get 2D context from canvas");r.width=a.width,r.height=a.height;const l={canvasContext:o,viewport:a};await n.render(l).promise;const c=o.getImageData(0,0,r.width,r.height),d=new((await Promise.resolve().then(function(){return i})).BlurDetector)({...this.config,edgeWidthThreshold:Math.min(this.config.edgeWidthThreshold||.5,.25),method:"edge",debug:this.config.debug}),h=await d.analyzeImage(c);h.method=`${h.method} (scale ${e}x)`,s.push(h),this.log(`Page ${t} at ${e}x scale:`,h)}const r=s.filter(e=>e.isBlurry).length,o=s.reduce((e,t)=>e+t.confidence,0)/s.length,l=s[s.length-1];return{...l,isBlurry:r>0,confidence:Math.max(o,r/s.length),method:`Multi-scale analysis (${r}/${s.length} scales detected blur)`,metrics:{...l.metrics,scaleResults:s.map(e=>{var t;return{scale:parseFloat((null===(t=e.method.match(/scale ([\d.]+)x/))||void 0===t?void 0:t[1])||"1"),isBlurry:e.isBlurry,confidence:e.confidence,edgeAnalysis:e.metrics.edgeAnalysis}})}}}analyzePageContent(e,t){const n=e.items||[],i=n.map(e=>e.str).join(" ").trim(),a=i.length,s=1===t,r=a<200,o=a/Math.max(n.length,1),l=/bill|statement|invoice|report|summary|account|period/i.test(i),c=/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\w+ \d{1,2}, \d{4}/i.test(i),d=/\$[\d,]+\.?\d*|USD|EUR|GBP/i.test(i),h=/certificate|certification|certified|diploma|award|achievement|completion|graduate|license|licence|accredited|qualification/i.test(i),g=/hereby|certify|certifies|awarded|granted|presented|conferred|issued|authority|institution|organization/i.test(i),u=h&&g,f=s&&(r||l&&c&&d&&a<500)&&!u;return this.log(`Page ${t} content analysis: textLength=${a}, textDensity=${o.toFixed(1)}, isLikelyHeader=${f}, isCertificate=${u}`),{isLikelyHeaderPage:f,textDensity:o,hasLowTextContent:r,isCertificateDocument:u}}async analyzeTextSharpness(e,t){const n=await e.getPage(t),i=await n.getTextContent();if(0===i.items.length)return{textSharpnessScore:0,isTextBlurry:!0,textMetrics:{reason:"No text found"}};const a=n.getViewport({scale:3}),s=document.createElement("canvas"),r=s.getContext("2d");if(!r)throw new Error("Could not get 2D context for text analysis");s.width=a.width,s.height=a.height;const o={canvasContext:r,viewport:a,intent:"print"};await n.render(o).promise;const l=r.getImageData(0,0,s.width,s.height),c=this.calculateTextSharpness(l,i.items);return this.log(`Page ${t} text sharpness analysis:`,c),c}calculateTextSharpness(e,t){const{data:n,width:i,height:a}=e;let s=0,r=0,o=0;const l=Math.max(1,Math.floor(Math.min(i,a)/100));for(let e=0;e<a-5;e+=l)for(let t=0;t<i-5;t+=l){let a=0,l=0,c=0,d=0;for(let s=0;s<5;s++)for(let r=0;r<5;r++){const o=4*((e+s)*i+(t+r)),h=.299*n[o]+.587*n[o+1]+.114*n[o+2];if(a+=h,l+=h*h,c++,r<4&&s<4){const a=4*((e+s)*i+(t+r+1)),o=4*((e+s+1)*i+(t+r)),l=.299*n[a]+.587*n[a+1]+.114*n[a+2]-h,c=.299*n[o]+.587*n[o+1]+.114*n[o+2]-h,g=Math.sqrt(l*l+c*c);d=Math.max(d,g)}}if(c>0){const e=a/c,t=l/c-e*e;t>100&&(s+=t,o+=d,r++)}}const c=r>0?s/r:0,d=r>0?o/r:0,h=c/1e3+d/50;return{textSharpnessScore:h,isTextBlurry:h<.8,textMetrics:{avgVariance:c,avgEdgeIntensity:d,sampleCount:r,threshold:.8}}}async analyzePDF(e){this.log("Starting PDF analysis for file:",e.name),this.pdfLib||await this.loadPdfJS();try{const t=await e.arrayBuffer(),n=await this.pdfLib.getDocument({data:new Uint8Array(t)}).promise;let i="",a=!1;const s=[];this.log(`PDF has ${n.numPages} pages`);for(let e=1;e<=n.numPages;e++){this.log(`Analyzing page ${e}/${n.numPages}`);const t=await n.getPage(e),r=await t.getTextContent();0===r.items.length&&(a=!0),i+=r.items.map(e=>e.str).join(" ");try{const t=this.analyzePageContent(r,e),i=await this.checkPdfPageQuality(n,e);if(r.items.length>0)try{const a=await this.analyzeTextSharpness(n,e);let r=i.isBlurry||a.isTextBlurry;t.isCertificateDocument?(r=a.textSharpnessScore<.3,this.log(`Page ${e} identified as certificate document - using very lenient blur criteria`)):t.isLikelyHeaderPage&&(r=a.textSharpnessScore<.5,this.log(`Page ${e} identified as likely header/logo page - using lenient blur criteria`));const o={...i,isBlurry:r,confidence:Math.max(i.confidence,a.textSharpnessScore),method:`${i.method} + Text Analysis${t.isCertificateDocument?" (Certificate-adjusted)":t.isLikelyHeaderPage?" (Header-adjusted)":""}`,metrics:{...i.metrics,textSharpness:a,contentAnalysis:t}};s.push(o),this.log(`Page ${e} combined analysis:`,o)}catch(t){this.log(`Text analysis failed for page ${e}:`,t),s.push(i)}else s.push(i)}catch(t){this.log(`Failed to analyze page ${e}:`,t)}}const r=i.length>=10,o=a||!r;this.log(`PDF analysis complete. Scanned: ${o}, Text length: ${i.length}`);let l=!0;if(s.length>0){const e=s.filter(e=>e.isBlurry);if(s.length>1){const e=s.slice(1),t=e.filter(e=>e.isBlurry),n=s[0].isBlurry,i=t.length>0;n&&!i?(this.log("First page marked as blurry but rest are clear - likely false positive due to graphics/logos"),l=!0):l=!(t.length>=Math.ceil(e.length/2)),this.log(`Smart quality check: First page blurry: ${n}, Rest pages blurry: ${t.length}/${e.length}, Final decision: ${l?"Good":"Poor"}`)}else l=0===e.length,this.log(`Single page quality check: ${e.length}/${s.length} pages are blurry`);this.log("PDF type: "+(o?"Scanned":"Text-based"))}const c={isQualityGood:l,isScanned:o,pagesAnalyzed:n.numPages,textLength:i.length,pageResults:s.length>0?s:void 0};return this.log("Final PDF analysis result:",c),c}catch(e){throw this.log("PDF analysis failed:",e),new Error(`PDF analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isGoodQuality(e){return(await this.analyzePDF(e)).isQualityGood}}class s{constructor(e={}){this.config={edgeWidthThreshold:.5,laplacianThreshold:100,method:"edge",debug:!1,...e},this.blurDetector=new n(this.config),this.pdfAnalyzer=new a(this.config)}async isImageBlurry(e){return this.blurDetector.isBlurry(e)}async analyzeImage(e){return this.blurDetector.analyzeImage(e)}async isPDFGoodQuality(e){return this.pdfAnalyzer.isGoodQuality(e)}async analyzePDF(e){return this.pdfAnalyzer.analyzePDF(e)}async analyzeFile(e,t={}){var i;const s=null===(i=e.name.split(".").pop())||void 0===i?void 0:i.toLowerCase(),r={...this.config,...t};if("pdf"===s){return new a(r).analyzePDF(e)}if(["png","jpg","jpeg","gif","bmp","webp"].includes(s||"")){return new n(r).analyzeImage(e)}throw new Error(`Unsupported file type: ${s}`)}async isFileGoodQuality(e,t={}){const n=await this.analyzeFile(e,t);return"isQualityGood"in n?n.isQualityGood:!n.isBlurry}updateConfig(e){this.config={...this.config,...e},this.blurDetector=new n(this.config),this.pdfAnalyzer=new a(this.config)}getConfig(){return{...this.config}}}async function r(e,t){return new s(t).isImageBlurry(e)}async function o(e,t){return new s(t).isPDFGoodQuality(e)}async function l(e,t){return new s(t).analyzeFile(e,t)}export{n as BlurDetector,s as BlurryCheck,e as Filters,t as OpenCVLoader,a as PDFAnalyzer,l as analyzeFile,s as default,r as isImageBlurry,o as isPDFGoodQuality};
//# sourceMappingURL=index.esm.js.map
