"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e={getFloat32Array:e=>Array.isArray(e)?e.slice(0):new Float32Array(e),createImageData(e,t){const i=(()=>{if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")})().getContext("2d");if(!i)throw new Error("Could not get 2D context");return i.createImageData(e,t)},luminance(e){const t=this.createImageData(e.width,e.height),i=t.data,n=e.data;for(let e=0;e<n.length;e+=4){const t=.2126*n[e]+.7152*n[e+1]+.0722*n[e+2];i[e]=i[e+1]=i[e+2]=t,i[e+3]=n[e+3]}return t},convolve(e,t,i){const n=Math.round(Math.sqrt(t.length)),a=Math.floor(n/2),r=e.data,s=e.width,o=e.height,l=s,c=o,d=this.createImageData(l,c),h=d.data,g=i?1:0;for(let e=0;e<c;e++)for(let i=0;i<l;i++){const c=4*(e*l+i);let d=0,u=0,f=0,m=0;for(let l=0;l<n;l++)for(let c=0;c<n;c++){const h=4*(Math.min(o-1,Math.max(0,e+l-a))*s+Math.min(s-1,Math.max(0,i+c-a))),g=t[l*n+c];d+=r[h]*g,u+=r[h+1]*g,f+=r[h+2]*g,m+=r[h+3]*g}h[c]=d,h[c+1]=u,h[c+2]=f,h[c+3]=m+g*(255-m)}return d},gaussianBlur(e,t){if((t=Math.abs(t))<=1)return e;const i=t/2,n=Math.ceil(t)+(1-Math.ceil(t)%2),a=this.getFloat32Array(n),r=(i+.5)/3,s=r*r,o=1/Math.sqrt(2*Math.PI*s),l=-1/(2*r*r),c=Math.floor(n/2);let d=0;for(let e=0;e<n;e++){const t=e-c,i=o*Math.exp(t*t*l);Float32Array,a[e]=i,d+=i}for(let e=0;e<a.length;e++)Float32Array,a[e]/=d;const h=this.convolve(e,a,!0);return this.convolve(h,a,!0)}};class t{constructor(e="https://docs.opencv.org/4.5.4/opencv.js"){this.loading=!1,this.loaded=!1,this.openCvUrl=e}static getInstance(e){return t.instance||(t.instance=new t(e)),t.instance}async loadOpenCV(){if("undefined"==typeof window)throw new Error("OpenCV.js can only be loaded in browser environments");if(this.loaded&&window.cv)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#opencv-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src=this.openCvUrl,t.async=!0,t.id="opencv-script";const i=new Promise((e,i)=>{t.onload=()=>{const t=setInterval(()=>{window.cv&&(clearInterval(t),this.loaded=!0,this.loading=!1,e())},100);setTimeout(()=>{clearInterval(t),this.loading=!1,i(new Error("OpenCV loading timeout"))},1e4)},t.onerror=()=>{this.loading=!1,i(new Error("Failed to load OpenCV"))}});document.body.appendChild(t),await i}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const i=setInterval(()=>{this.loading||(clearInterval(i),this.loaded&&window.cv?e():t(new Error("OpenCV failed to load")))},100);setTimeout(()=>{clearInterval(i),t(new Error("OpenCV loading timeout"))},15e3)})}isLoaded(){return this.loaded&&"undefined"!=typeof window&&!!window.cv}getCV(){if(!this.isLoaded())throw new Error("OpenCV is not loaded. Call loadOpenCV() first.");return window.cv}}class i{constructor(e={}){var i,n,a,r,s,o;this.config={edgeWidthThreshold:null!==(i=e.edgeWidthThreshold)&&void 0!==i?i:.5,laplacianThreshold:null!==(n=e.laplacianThreshold)&&void 0!==n?n:100,method:null!==(a=e.method)&&void 0!==a?a:"edge",openCvUrl:null!==(r=e.openCvUrl)&&void 0!==r?r:"https://docs.opencv.org/4.5.4/opencv.js",canvas:null!==(s=e.canvas)&&void 0!==s?s:this.createCanvas(),debug:null!==(o=e.debug)&&void 0!==o&&o},this.openCvLoader=t.getInstance(this.config.openCvUrl)}createCanvas(){if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Canvas not available in this environment")}log(e,...t){this.config.debug&&console.log(`[BlurDetector] ${e}`,...t)}detectEdges(t){const i=e.luminance(t),n=e.getFloat32Array([1,0,-1,2,0,-2,1,0,-1]);return e.convolve(i,n,!0)}reducedPixels(e){const{data:t,width:i}=e,n=4*i,a=[];for(let e=0;e<t.length;e+=n){const r=new Uint8ClampedArray(i);let s=0;for(let i=e;i<e+n;i+=4)r[s]=t[i],s+=1;a.push(r)}return a}detectBlur(e){const t=e[0].length,i=e.length;let n=0,a=0;for(let r=0;r<i;r++){let i=-1;for(let s=0;s<t;s++){const t=e[r][s];if(i>=0&&s>i){const o=e[r][s-1];if(t<o){if(o>=20){n++,a+=s-i-1}i=-1}}0===t&&(i=s)}}if(0===n)return{width:t,height:i,numEdges:0,avgEdgeWidth:0,avgEdgeWidthPerc:0};const r=a/n;return{width:t,height:i,numEdges:n,avgEdgeWidth:r,avgEdgeWidthPerc:r/t*100}}measureBlurByEdges(e){const t=this.detectEdges(e),i=this.reducedPixels(t);return this.detectBlur(i)}async detectBlurrinessWithOpenCV(e){this.openCvLoader.isLoaded()||await this.openCvLoader.loadOpenCV();const t=this.openCvLoader.getCV(),i=t.matFromImageData(e),n=new t.Mat;t.cvtColor(i,n,t.COLOR_RGBA2GRAY,0);const a=new t.Mat;t.Laplacian(n,a,t.CV_64F);const r=new t.Mat,s=new t.Mat;t.meanStdDev(a,r,s);const o=s.data64F[0]**2;return i.delete(),n.delete(),a.delete(),r.delete(),s.delete(),o}async getImageData(e){if(e instanceof ImageData)return e;const t=this.config.canvas,i=t.getContext("2d");if(!i)throw new Error("Could not get 2D context from canvas");if(e instanceof File)return new Promise((n,a)=>{const r=new FileReader;r.onload=e=>{var r;const s=new Image;s.onload=()=>{t.width=s.width,t.height=s.height,i.drawImage(s,0,0),n(i.getImageData(0,0,t.width,t.height))},s.onerror=a,s.src=null===(r=e.target)||void 0===r?void 0:r.result},r.onerror=a,r.readAsDataURL(e)});if(e instanceof HTMLImageElement)return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,t.width,t.height);if(e instanceof HTMLCanvasElement){const t=e.getContext("2d");if(!t)throw new Error("Could not get 2D context from source canvas");return t.getImageData(0,0,e.width,e.height)}throw new Error("Unsupported input type")}async analyzeImage(e){this.log("Starting blur analysis with method:",this.config.method);const t=await this.getImageData(e);this.log("Image data obtained:",t.width,"x",t.height);const i={isBlurry:!1,confidence:0,metrics:{},method:this.config.method};try{if("edge"===this.config.method||"both"===this.config.method){const e=this.measureBlurByEdges(t);i.metrics.edgeAnalysis=e;const n=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,a=e.numEdges<t.width*t.height/1e4,r=n||a;this.log("Edge analysis result:",e,"isBlurry:",n,"lowEdgeCount:",a,"combined:",r),"edge"===this.config.method&&(i.isBlurry=r,i.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1))}if("laplacian"===this.config.method||"both"===this.config.method)try{const e=await this.detectBlurrinessWithOpenCV(t);i.metrics.laplacianVariance=e;const n=e<this.config.laplacianThreshold;this.log("Laplacian analysis result:",e,"isBlurry:",n),"laplacian"===this.config.method&&(i.isBlurry=n,i.confidence=Math.min(this.config.laplacianThreshold/e,1))}catch(e){if(this.log("OpenCV analysis failed, falling back to edge detection:",e),"laplacian"===this.config.method){const e=this.measureBlurByEdges(t);i.metrics.edgeAnalysis=e,i.isBlurry=e.avgEdgeWidthPerc>this.config.edgeWidthThreshold,i.confidence=Math.min(e.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1),i.method="edge (fallback)"}}if("both"===this.config.method){const e=!!i.metrics.edgeAnalysis&&i.metrics.edgeAnalysis.avgEdgeWidthPerc>this.config.edgeWidthThreshold,n=!!i.metrics.edgeAnalysis&&i.metrics.edgeAnalysis.numEdges<t.width*t.height/1e4,a=e||n,r=!!i.metrics.laplacianVariance&&i.metrics.laplacianVariance<this.config.laplacianThreshold;i.isBlurry=a||r;const s=i.metrics.edgeAnalysis?Math.min(i.metrics.edgeAnalysis.avgEdgeWidthPerc/this.config.edgeWidthThreshold,1):0,o=i.metrics.laplacianVariance?Math.min(this.config.laplacianThreshold/i.metrics.laplacianVariance,1):0;i.confidence=Math.max(s,o)}return this.log("Final analysis result:",i),i}catch(e){throw this.log("Analysis failed:",e),new Error(`Blur analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isBlurry(e){return(await this.analyzeImage(e)).isBlurry}}var n=Object.freeze({__proto__:null,BlurDetector:i});class a{constructor(e={}){this.pdfLib=null,this.loading=!1,this.config=e,this.blurDetector=new i(e)}log(e,...t){this.config.debug&&console.log(`[PDFAnalyzer] ${e}`,...t)}async loadPdfJS(){if("undefined"==typeof window)throw new Error("PDF.js can only be loaded in browser environments");if(this.pdfLib)return Promise.resolve();if(this.loading)return this.waitForLoad();this.loading=!0;try{const e=document.querySelector("#pdfjs-script");e&&document.body.removeChild(e);const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.async=!0,t.id="pdfjs-script";const i=new Promise((e,i)=>{t.onload=()=>{window.pdfjsLib?(window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",this.pdfLib=window.pdfjsLib,this.loading=!1,e()):(this.loading=!1,i(new Error("PDF.js not available after loading")))},t.onerror=()=>{this.loading=!1,i(new Error("Failed to load PDF.js"))}});document.body.appendChild(t),await i}catch(e){throw this.loading=!1,e}}async waitForLoad(){return new Promise((e,t)=>{const i=setInterval(()=>{this.loading||(clearInterval(i),this.pdfLib?e():t(new Error("PDF.js failed to load")))},100);setTimeout(()=>{clearInterval(i),t(new Error("PDF.js loading timeout"))},15e3)})}async checkPdfPageQuality(e,t){const i=await e.getPage(t),a=[1,1.5,2],r=[];for(const e of a){const a=i.getViewport({scale:e}),s=this.config.canvas||document.createElement("canvas"),o=s.getContext("2d");if(!o)throw new Error("Could not get 2D context from canvas");s.width=a.width,s.height=a.height;const l={canvasContext:o,viewport:a};await i.render(l).promise;const c=o.getImageData(0,0,s.width,s.height),d=new((await Promise.resolve().then(function(){return n})).BlurDetector)({...this.config,edgeWidthThreshold:Math.min(this.config.edgeWidthThreshold||.5,.25),method:"edge",debug:this.config.debug}),h=await d.analyzeImage(c);h.method=`${h.method} (scale ${e}x)`,r.push(h),this.log(`Page ${t} at ${e}x scale:`,h)}const s=r.filter(e=>e.isBlurry).length,o=r.reduce((e,t)=>e+t.confidence,0)/r.length,l=r[r.length-1];return{...l,isBlurry:s>0,confidence:Math.max(o,s/r.length),method:`Multi-scale analysis (${s}/${r.length} scales detected blur)`,metrics:{...l.metrics,scaleResults:r.map(e=>{var t;return{scale:parseFloat((null===(t=e.method.match(/scale ([\d.]+)x/))||void 0===t?void 0:t[1])||"1"),isBlurry:e.isBlurry,confidence:e.confidence,edgeAnalysis:e.metrics.edgeAnalysis}})}}}analyzePageContent(e,t){const i=e.items||[],n=i.map(e=>e.str).join(" ").trim(),a=n.length,r=1===t,s=a<200,o=a/Math.max(i.length,1),l=/bill|statement|invoice|report|summary|account|period/i.test(n),c=/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\w+ \d{1,2}, \d{4}/i.test(n),d=/\$[\d,]+\.?\d*|USD|EUR|GBP/i.test(n),h=/certificate|certification|certified|diploma|award|achievement|completion|graduate|license|licence|accredited|qualification/i.test(n),g=/hereby|certify|certifies|awarded|granted|presented|conferred|issued|authority|institution|organization/i.test(n),u=h&&g,f=r&&(s||l&&c&&d&&a<500)&&!u;return this.log(`Page ${t} content analysis: textLength=${a}, textDensity=${o.toFixed(1)}, isLikelyHeader=${f}, isCertificate=${u}`),{isLikelyHeaderPage:f,textDensity:o,hasLowTextContent:s,isCertificateDocument:u}}async analyzeTextSharpness(e,t){const i=await e.getPage(t),n=await i.getTextContent();if(0===n.items.length)return{textSharpnessScore:0,isTextBlurry:!0,textMetrics:{reason:"No text found"}};const a=i.getViewport({scale:3}),r=document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("Could not get 2D context for text analysis");r.width=a.width,r.height=a.height;const o={canvasContext:s,viewport:a,intent:"print"};await i.render(o).promise;const l=s.getImageData(0,0,r.width,r.height),c=this.calculateTextSharpness(l,n.items);return this.log(`Page ${t} text sharpness analysis:`,c),c}calculateTextSharpness(e,t){const{data:i,width:n,height:a}=e;let r=0,s=0,o=0;const l=Math.max(1,Math.floor(Math.min(n,a)/100));for(let e=0;e<a-5;e+=l)for(let t=0;t<n-5;t+=l){let a=0,l=0,c=0,d=0;for(let r=0;r<5;r++)for(let s=0;s<5;s++){const o=4*((e+r)*n+(t+s)),h=.299*i[o]+.587*i[o+1]+.114*i[o+2];if(a+=h,l+=h*h,c++,s<4&&r<4){const a=4*((e+r)*n+(t+s+1)),o=4*((e+r+1)*n+(t+s)),l=.299*i[a]+.587*i[a+1]+.114*i[a+2]-h,c=.299*i[o]+.587*i[o+1]+.114*i[o+2]-h,g=Math.sqrt(l*l+c*c);d=Math.max(d,g)}}if(c>0){const e=a/c,t=l/c-e*e;t>100&&(r+=t,o+=d,s++)}}const c=s>0?r/s:0,d=s>0?o/s:0,h=c/1e3+d/50;return{textSharpnessScore:h,isTextBlurry:h<.8,textMetrics:{avgVariance:c,avgEdgeIntensity:d,sampleCount:s,threshold:.8}}}async analyzePDF(e){this.log("Starting PDF analysis for file:",e.name),this.pdfLib||await this.loadPdfJS();try{const t=await e.arrayBuffer(),i=await this.pdfLib.getDocument({data:new Uint8Array(t)}).promise;let n="",a=!1;const r=[];this.log(`PDF has ${i.numPages} pages`);for(let e=1;e<=i.numPages;e++){this.log(`Analyzing page ${e}/${i.numPages}`);const t=await i.getPage(e),s=await t.getTextContent();0===s.items.length&&(a=!0),n+=s.items.map(e=>e.str).join(" ");try{const t=this.analyzePageContent(s,e),n=await this.checkPdfPageQuality(i,e);if(s.items.length>0)try{const a=await this.analyzeTextSharpness(i,e);let s=n.isBlurry||a.isTextBlurry;t.isCertificateDocument?(s=a.textSharpnessScore<.3,this.log(`Page ${e} identified as certificate document - using very lenient blur criteria`)):t.isLikelyHeaderPage&&(s=a.textSharpnessScore<.5,this.log(`Page ${e} identified as likely header/logo page - using lenient blur criteria`));const o={...n,isBlurry:s,confidence:Math.max(n.confidence,a.textSharpnessScore),method:`${n.method} + Text Analysis${t.isCertificateDocument?" (Certificate-adjusted)":t.isLikelyHeaderPage?" (Header-adjusted)":""}`,metrics:{...n.metrics,textSharpness:a,contentAnalysis:t}};r.push(o),this.log(`Page ${e} combined analysis:`,o)}catch(t){this.log(`Text analysis failed for page ${e}:`,t),r.push(n)}else r.push(n)}catch(t){this.log(`Failed to analyze page ${e}:`,t)}}const s=n.length>=10,o=a||!s;this.log(`PDF analysis complete. Scanned: ${o}, Text length: ${n.length}`);let l=!0;if(r.length>0){const e=r.filter(e=>e.isBlurry);if(r.length>1){const e=r.slice(1),t=e.filter(e=>e.isBlurry),i=r[0].isBlurry,n=t.length>0;i&&!n?(this.log("First page marked as blurry but rest are clear - likely false positive due to graphics/logos"),l=!0):l=!(t.length>=Math.ceil(e.length/2)),this.log(`Smart quality check: First page blurry: ${i}, Rest pages blurry: ${t.length}/${e.length}, Final decision: ${l?"Good":"Poor"}`)}else l=0===e.length,this.log(`Single page quality check: ${e.length}/${r.length} pages are blurry`);this.log("PDF type: "+(o?"Scanned":"Text-based"))}const c={isQualityGood:l,isScanned:o,pagesAnalyzed:i.numPages,textLength:n.length,pageResults:r.length>0?r:void 0};return this.log("Final PDF analysis result:",c),c}catch(e){throw this.log("PDF analysis failed:",e),new Error(`PDF analysis failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async isGoodQuality(e){return(await this.analyzePDF(e)).isQualityGood}}class r{constructor(e={}){this.config={edgeWidthThreshold:.5,laplacianThreshold:100,method:"edge",debug:!1,...e},this.blurDetector=new i(this.config),this.pdfAnalyzer=new a(this.config)}async isImageBlurry(e){return this.blurDetector.isBlurry(e)}async analyzeImage(e){return this.blurDetector.analyzeImage(e)}async isPDFGoodQuality(e){return this.pdfAnalyzer.isGoodQuality(e)}async analyzePDF(e){return this.pdfAnalyzer.analyzePDF(e)}async analyzeFile(e,t={}){var n;const r=null===(n=e.name.split(".").pop())||void 0===n?void 0:n.toLowerCase(),s={...this.config,...t};if("pdf"===r){return new a(s).analyzePDF(e)}if(["png","jpg","jpeg","gif","bmp","webp"].includes(r||"")){return new i(s).analyzeImage(e)}throw new Error(`Unsupported file type: ${r}`)}async isFileGoodQuality(e,t={}){const i=await this.analyzeFile(e,t);return"isQualityGood"in i?i.isQualityGood:!i.isBlurry}updateConfig(e){this.config={...this.config,...e},this.blurDetector=new i(this.config),this.pdfAnalyzer=new a(this.config)}getConfig(){return{...this.config}}}exports.BlurDetector=i,exports.BlurryCheck=r,exports.Filters=e,exports.OpenCVLoader=t,exports.PDFAnalyzer=a,exports.analyzeFile=async function(e,t){return new r(t).analyzeFile(e,t)},exports.default=r,exports.isImageBlurry=async function(e,t){return new r(t).isImageBlurry(e)},exports.isPDFGoodQuality=async function(e,t){return new r(t).isPDFGoodQuality(e)};
//# sourceMappingURL=index.js.map
